---
title: "Kvalitetskontroll"
author: "Vegard"
date: "`r Sys.Date()`"
format: 
  html:
    df-print: kable
execute: 
  cache: true
---

# Kvalitetskontroll

TODO

-   nederst: var alt ok, klikk her: kopierer filen over i NESTTAR-mappe klar for publisering. Må legge inn årstall i input for å finne riktig mappe.
-   Lage kvalkontroll del 2 for plotting?
-   Lage mappesystem for lagring av plott
-   Fikse encodingproblemer
-   Create documentation in separate file

```{r}
#| include: false
#| message: false

# GITHUB
# source("https://raw.githubusercontent.com/vegardlysne/KHvalitet/main/R/setup.R")
# source("https://raw.githubusercontent.com/vegardlysne/KHvalitet/main/R/functions#.R")

# TESTING
source("./R/setup.R")
source("./R/functions.R")
```

## Input

-   Add path to new KUBE to be controlled (dfnew), og gammel KUBE (dfold) som brukes som sammenligningsgrunnlag for deler av kvalitetskontrollen.
-   `_*dims` refer to dimension columns
-   `_*val` refer to value columns
-   `_*limit` refer to thresholds, e.g. limit for PRIKKING

[**Define:**]{.underline}

-   **STANDARDdims**: All standard dimensions in KUBE
-   **EXTRAdims** (If none, write `NULL`)
-   **PRIKKval**: The target number for PRIKKING
-   **PRIKKlimit**: Hva er grensen for det som skal være prikket?
-   **COMPAREval**: Hvilken variabel som skal brukes for å se om kommuner summerer til fylke, og fylke summerer til land

```{r}
#| include: false
dfnew <- "F:/Forskningsprosjekter/PDB 2455 - Helseprofiler og til_/PRODUKSJON/PRODUKTER/KUBER/KOMMUNEHELSA/DATERT/csv/KUHR_2022-09-01-09-03.csv"
dfold <- "F:/Forskningsprosjekter/PDB 2455 - Helseprofiler og til_/PRODUKSJON/PRODUKTER/KUBER/KOMMUNEHELSA/KH2022NESSTAR/KUHR_2022-02-09-17-50.csv"

STANDARDdims <- c("GEO", "AAR", "KJONN", "ALDER")
EXTRAdims <- c("KODEGRUPPE") # If no additional dimensions, this should be "EXTRAdims <- NULL"
PRIKKval <- "sumTELLER"
PRIKKlimit <- 8
COMPAREval <- "TELLER"

#-----NO INPUT BELOW THIS-----
dfnew <- fread(dfnew)
dfold <- fread(dfold)
```

## Inspect data manually

-   Useful codes to initially inspect KUBE
-   For interactive use only

```{r}
#| include: false 
#| eval: false

# Scroll through KUBE
dfnew

# List variable names
names(dfnew)

# General summary
summary(dfnew)
```

# 1. Compare dimensions

-   The function compares the levels within dimensions defined under INPUT as `STANDARDdims`and `EXTRAdims`.

[**Output:**]{.underline}

-   Number of levels in each dimension (new KUBE)
-   New levels, which did not exist in previous KUBE
-   Expired levels, which existed in previous KUBE, but not in the new KUBE. **NB: Should these be present?**

```{r}
#| message: false
CompareDims()
```

# 2. Compare number of PRIKK

-   Calculates the amount of cencored observations in new and old KUBE, grouped by type of SPVFLAGG and the `EXTRAdims` as defined in `Input`. If `EXTRAdims <- NULL`, output is only grouped by type of SPVFLAGG
-   Absolute (new - old KUBE) and relative (new/old cube) difference is calculated and given per group.

```{r}
ComparePrikk()
```

# 3. Are all values below the limit cencored? 

-   Checks whether all values of `PRIKKval` \<= `PRIKKlimit`, as defined in `Input`
-   If everything is ok, the function returns a confirmation.
-   If some values at or below PRIKKlimit is present, the corresponding rows are printed for inspection.

```{r}
CheckPrikk()
```

# 4. Does FYLKE sum to LAND? 

-   Summarise `COMPAREval` for FYLKE and LAND, grouped by `EXTRAdims`

-   Calculate the absolute (LAND - FYLKE) and relative (LAND/FYLKE) difference

-   Orders the input according to the relative difference.

(### TODO: Add possibility to group also by other variables, such as ALDER)

```{r}
CompareLandFylke()
```

# Sjekke om sum av bydel blir kommune

-   **COMPAREval** og **EXTRAdims** er definert i INPUT
-   Summerer COMPAREvalen for hver undergruppe av ekstradimensjonen(e) for fylker og landet.
-   Beregner absolutt (Kommune - Bydel) og relativ (Kommune / bydel) forskjell.
-   Rangerer output p? synkende relativ forskjell, disse b? v?re s? n?r 1 som mulig. Ved perfekt samsvar vil relativ v?re 1.0

```{r}
CompareBydelKommune() %>% datatable()
```
